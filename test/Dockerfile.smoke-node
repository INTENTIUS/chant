# Node.js smoke test â€” validates chant CLI under Node.js + tsx
FROM node:22-slim
WORKDIR /app

RUN apt-get update && apt-get install -y jq curl unzip && rm -rf /var/lib/apt/lists/*
RUN npm i -g tsx

# Install bun for workspace dependency resolution (workspace: protocol is bun/pnpm-only)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

COPY . .
RUN bun install

COPY test/integration.sh /app/test/integration.sh
RUN chmod +x /app/test/integration.sh && CHANT_RUNTIME=node /app/test/integration.sh 2>&1 || (echo "--- FULL OUTPUT ABOVE ---" && false)

# Remove bun so the chant wrapper uses Node.js + tsx
# (bun was only needed for workspace dependency resolution)
RUN rm -rf /root/.bun
ENV PATH="/app/lexicons/gitlab/node_modules/.bin:/app/lexicons/aws/node_modules/.bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

WORKDIR /app/lexicons/aws/examples/getting-started

CMD ["bash"]
